pipeline {
    agent any

    environment {
        K8S_NAMESPACE_DEV = 'bankapp-dev'
        K8S_NAMESPACE_TEST = 'bankapp-test'
        K8S_NAMESPACE_PROD = 'bankapp-prod'
        
        SERVICE_ACCOUNTS_TAG = 'latest'
        SERVICE_GATEWAY_TAG = 'latest'
        SERVICE_FRONT_TAG = 'latest'
        SERVICE_CASH_TAG = 'latest'
        SERVICE_TRANSFER_TAG = 'latest'
        SERVICE_CONVERT_TAG = 'latest'
        SERVICE_EXCHANGE_TAG = 'latest'
        SERVICE_BLOCKER_TAG = 'latest'
        SERVICE_NOTIFICATIONS_TAG = 'latest'
    }

    parameters {
        string(name: 'SERVICE_ACCOUNTS_TAG', defaultValue: 'latest', description: 'service-accounts image tag')
        string(name: 'SERVICE_GATEWAY_TAG', defaultValue: 'latest', description: 'service-gateway image tag')
        string(name: 'SERVICE_FRONT_TAG', defaultValue: 'latest', description: 'service-front image tag')
        string(name: 'SERVICE_CASH_TAG', defaultValue: 'latest', description: 'service-cash image tag')
        string(name: 'SERVICE_TRANSFER_TAG', defaultValue: 'latest', description: 'service-transfer image tag')
        string(name: 'SERVICE_CONVERT_TAG', defaultValue: 'latest', description: 'service-convert image tag')
        string(name: 'SERVICE_EXCHANGE_TAG', defaultValue: 'latest', description: 'service-exchange image tag')
        string(name: 'SERVICE_BLOCKER_TAG', defaultValue: 'latest', description: 'service-blocker image tag')
        string(name: 'SERVICE_NOTIFICATIONS_TAG', defaultValue: 'latest', description: 'service-notifications image tag')
        
        choice(name: 'DEPLOY_ENV', choices: ['dev', 'test', 'prod'], description: 'Environment to deploy to')
        booleanParam(name: 'SKIP_TESTS', defaultValue: false, description: 'Skip Helm tests')
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '10'))
        disableConcurrentBuilds()
    }

    stages {
        stage('Инициализация') {
            steps {
                echo "Запуск полного цикла сборки и деплоя bankapp"
                echo "Окружение: ${params.DEPLOY_ENV}"
            }
        }

        stage('Получение исходников') {
            steps {
                checkout scm
            }
        }

        stage('Сборка всех проектов') {
            steps {
                sh "./gradlew clean build -x test"
                archiveArtifacts artifacts: "**/build/libs/*.jar", fingerprint: true
            }
        }

        stage('Запуск тестов') {
            parallel {
                stage('service-accounts тесты') {
                    steps {
                        catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                            sh "./gradlew :service-accounts:test"
                        }
                    }
                    post {
                        always {
                            junit "service-accounts/build/test-results/test/*.xml"
                        }
                    }
                }
                stage('service-gateway тесты') {
                    steps {
                        catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                            sh "./gradlew :service-gateway:test"
                        }
                    }
                    post {
                        always {
                            junit "service-gateway/build/test-results/test/*.xml"
                        }
                    }
                }
                stage('service-cash тесты') {
                    steps {
                        catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                            sh "./gradlew :service-cash:test"
                        }
                    }
                    post {
                        always {
                            junit "service-cash/build/test-results/test/*.xml"
                        }
                    }
                }
                stage('service-transfer тесты') {
                    steps {
                        catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                            sh "./gradlew :service-transfer:test"
                        }
                    }
                    post {
                        always {
                            junit "service-transfer/build/test-results/test/*.xml"
                        }
                    }
                }
                stage('service-convert тесты') {
                    steps {
                        catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                            sh "./gradlew :service-convert:test"
                        }
                    }
                    post {
                        always {
                            junit "service-convert/build/test-results/test/*.xml"
                        }
                    }
                }
                stage('service-exchange тесты') {
                    steps {
                        catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                            sh "./gradlew :service-exchange:test"
                        }
                    }
                    post {
                        always {
                            junit "service-exchange/build/test-results/test/*.xml"
                        }
                    }
                }
                stage('service-blocker тесты') {
                    steps {
                        catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                            sh "./gradlew :service-blocker:test"
                        }
                    }
                    post {
                        always {
                            junit "service-blocker/build/test-results/test/*.xml"
                        }
                    }
                }
                stage('service-notifications тесты') {
                    steps {
                        catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                            sh "./gradlew :service-notifications:test"
                        }
                    }
                    post {
                        always {
                            junit "service-notifications/build/test-results/test/*.xml"
                        }
                    }
                }
                stage('service-front тесты') {
                    steps {
                        catchError(buildResult: 'SUCCESS', stageResult: 'FAILURE') {
                            sh "./gradlew :service-front:test"
                        }
                    }
                    post {
                        always {
                            junit "service-front/build/test-results/test/*.xml"
                        }
                    }
                }
            }
        }

        stage('Сборка Docker образов') {
            parallel {
                stage('service-accounts образ') {
                    steps {
                        sh """
                            docker build -f service-accounts/Dockerfile \\
                            --build-arg JAR_FILE=build/libs/*.jar \\
                            -t service-accounts-app:latest .
                        """
                    }
                }
                stage('service-gateway образ') {
                    steps {
                        sh """
                            docker build -f service-gateway/Dockerfile \\
                            --build-arg JAR_FILE=build/libs/*.jar \\
                            -t service-gateway-app:latest .
                        """
                    }
                }
                stage('service-cash образ') {
                    steps {
                        sh """
                            docker build -f service-cash/Dockerfile \\
                            --build-arg JAR_FILE=build/libs/*.jar \\
                            -t service-cash-app:latest .
                        """
                    }
                }
                stage('service-transfer образ') {
                    steps {
                        sh """
                            docker build -f service-transfer/Dockerfile \\
                            --build-arg JAR_FILE=build/libs/*.jar \\
                            -t service-transfer-app:latest .
                        """
                    }
                }
                stage('service-convert образ') {
                    steps {
                        sh """
                            docker build -f service-convert/Dockerfile \\
                            --build-arg JAR_FILE=build/libs/*.jar \\
                            -t service-convert-app:latest .
                        """
                    }
                }
                stage('service-exchange образ') {
                    steps {
                        sh """
                            docker build -f service-exchange/Dockerfile \\
                            --build-arg JAR_FILE=build/libs/*.jar \\
                            -t service-exchange-app:latest .
                        """
                    }
                }
                stage('service-blocker образ') {
                    steps {
                        sh """
                            docker build -f service-blocker/Dockerfile \\
                            --build-arg JAR_FILE=build/libs/*.jar \\
                            -t service-blocker-app:latest .
                        """
                    }
                }
                stage('service-notifications образ') {
                    steps {
                        sh """
                            docker build -f service-notifications/Dockerfile \\
                            --build-arg JAR_FILE=build/libs/*.jar \\
                            -t service-notifications-app:latest .
                        """
                    }
                }
                stage('service-front образ') {
                    steps {
                        sh """
                            docker build -f service-front/Dockerfile \\
                            --build-arg JAR_FILE=build/libs/*.jar \\
                            -t service-front-app:latest .
                        """
                    }
                }
            }
        }

        stage('Загрузка образов в Minikube') {
            parallel {
                stage('Load service-accounts') {
                    steps {
                        sh "minikube image load service-accounts-app:latest"
                    }
                }
                stage('Load service-gateway') {
                    steps {
                        sh "minikube image load service-gateway-app:latest"
                    }
                }
                stage('Load service-cash') {
                    steps {
                        sh "minikube image load service-cash-app:latest"
                    }
                }
                stage('Load service-transfer') {
                    steps {
                        sh "minikube image load service-transfer-app:latest"
                    }
                }
                stage('Load service-convert') {
                    steps {
                        sh "minikube image load service-convert-app:latest"
                    }
                }
                stage('Load service-exchange') {
                    steps {
                        sh "minikube image load service-exchange-app:latest"
                    }
                }
                stage('Load service-blocker') {
                    steps {
                        sh "minikube image load service-blocker-app:latest"
                    }
                }
                stage('Load service-notifications') {
                    steps {
                        sh "minikube image load service-notifications-app:latest"
                    }
                }
                stage('Load service-front') {
                    steps {
                        sh "minikube image load service-front-app:latest"
                    }
                }
            }
        }

        stage('Подготовка Helm зависимостей') {
            steps {
                sh "helm dependency build ./helm/bankapp"
            }
        }

        stage('Очистка конфликтующих ресурсов') {
            steps {
                script {
                    def namespace = ""
                    if (params.DEPLOY_ENV == 'dev') {
                        namespace = K8S_NAMESPACE_DEV
                    } else if (params.DEPLOY_ENV == 'test') {
                        namespace = K8S_NAMESPACE_TEST
                    } else if (params.DEPLOY_ENV == 'prod') {
                        namespace = K8S_NAMESPACE_PROD
                    }
                    
                    sh """
                        # Удаляем конфликтующие Ingress ресурсы
                        kubectl delete ingress --all -n ${namespace} --ignore-not-found=true || true
                        kubectl delete ingress --all -n bankapp --ignore-not-found=true || true
                    """
                }
            }
        }

        stage('Деплой Dev') {
            when {
                anyOf {
                    expression { params.DEPLOY_ENV == 'dev' }
                    expression { params.DEPLOY_ENV == 'test' }
                    expression { params.DEPLOY_ENV == 'prod' }
                }
            }
            steps {
                script {
                    def namespace = ""
                    if (params.DEPLOY_ENV == 'dev') {
                        namespace = K8S_NAMESPACE_DEV
                    } else if (params.DEPLOY_ENV == 'test') {
                        namespace = K8S_NAMESPACE_TEST
                    } else if (params.DEPLOY_ENV == 'prod') {
                        namespace = K8S_NAMESPACE_PROD
                    }
                    
                    echo "Деплой в окружение ${params.DEPLOY_ENV} (namespace: ${namespace})"
                    
                    sh """
                        helm upgrade --install bankapp ./helm/bankapp \\
                        --namespace ${namespace} \\
                        --create-namespace \\
                        --timeout=300s
                    """
                }
            }
        }

        stage('Запуск Helm тестов') {
            when {
                not { 
                    equals expected: true, actual: params.SKIP_TESTS
                }
            }
            steps {
                script {
                    def namespace = ""
                    if (params.DEPLOY_ENV == 'dev') {
                        namespace = K8S_NAMESPACE_DEV
                    } else if (params.DEPLOY_ENV == 'test') {
                        namespace = K8S_NAMESPACE_TEST
                    } else if (params.DEPLOY_ENV == 'prod') {
                        namespace = K8S_NAMESPACE_PROD
                    }
                    
                    sh """
                        helm test bankapp \\
                        --namespace ${namespace} \\
                        --timeout=300s
                    """
                }
            }
        }

        stage('Проверка статуса подов') {
            steps {
                script {
                    def namespace = ""
                    if (params.DEPLOY_ENV == 'dev') {
                        namespace = K8S_NAMESPACE_DEV
                    } else if (params.DEPLOY_ENV == 'test') {
                        namespace = K8S_NAMESPACE_TEST
                    } else if (params.DEPLOY_ENV == 'prod') {
                        namespace = K8S_NAMESPACE_PROD
                    }
                    
                    sh """
                        echo "Проверка статуса подов в namespace ${namespace}:"
                        kubectl get pods -n ${namespace}
                        
                        echo "Проверка сервисов:"
                        kubectl get services -n ${namespace}
                        
                        echo "Ожидание готовности всех подов..."
                        kubectl wait --for=condition=ready pod --all -n ${namespace} --timeout=600s --ignore-not-found=true
                    """
                }
            }
        }

        stage('Подтверждение для Production') {
            when {
                expression { params.DEPLOY_ENV == 'prod' }
            }
            input {
                message "Подтвердите деплой в Production"
                ok "Deploy to Production"
                parameters {
                    choice(name: 'CONFIRM_PROD', choices: ['no', 'yes'], description: 'Подтвердить деплой в production')
                }
            }
            steps {
                script {
                    if (params.CONFIRM_PROD != 'yes') {
                        error("Деплой в production отменен пользователем")
                    }
                    echo "Деплой в production подтвержден"
                }
            }
        }
    }

    post {
        always {
            script {
                def namespace = ""
                if (params.DEPLOY_ENV == 'dev') {
                    namespace = K8S_NAMESPACE_DEV
                } else if (params.DEPLOY_ENV == 'test') {
                    namespace = K8S_NAMESPACE_TEST
                } else if (params.DEPLOY_ENV == 'prod') {
                    namespace = K8S_NAMESPACE_PROD
                }
                
                echo "Итоговый статус деплоя в ${params.DEPLOY_ENV}:"
                sh "kubectl get pods -n ${namespace} || true"
            }
        }
        success {
            echo "Umbrella деплой bankapp в ${params.DEPLOY_ENV} завершен успешно"
        }
        failure {
            echo "Umbrella деплой bankapp в ${params.DEPLOY_ENV} завершился с ошибкой"
        }
    }
}